name: CMake Windows Multi-Arch CI

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            vcvars_arg: x64
            package_arch: x64
          - arch: arm64
            vcvars_arg: x64_arm64
            package_arch: arm64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Extract Version
        id: extract_version
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -match "^refs/tags/v(\d+\.\d+\.\d+)") {
            $version = $matches[1]
          } else {
            $version = (Select-String -Path "CMakeLists.txt" -Pattern "VERSION (\d+\.\d+\.\d+)").Matches.Groups[1].Value
          }
          echo "project_version=$version" >> $env:GITHUB_OUTPUT

      - name: Configure CMake (Release Mode)
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.vcvars_arg }}
          cmake -B build-${{ matrix.package_arch }} ^
            -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_C_COMPILER_TARGET=${{ matrix.arch }} ^
            -DCMAKE_CXX_COMPILER_TARGET=${{ matrix.arch }} ^
            -DBUILD_MODE=RELEASE ^
            -DUSE_STATIC_CRT=ON ^
            -DUSE_HARDLINKS=ON ^
            -DCMAKE_CXX_STANDARD=23 ^
            -DCMAKE_CXX_STANDARD_REQUIRED=ON ^
            -DCMAKE_EXPERIMENTAL_CXX_MODULE_STD=ON ^
            -DCMAKE_CXX_MODULE_STD=ON ^
            -DCMAKE_CXX_FLAGS="/std:c++latest /EHsc"

      - name: Build Project
        shell: cmd
        working-directory: build-${{ matrix.package_arch }}
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.vcvars_arg }}
          cmake --build . --config Release --parallel %NUMBER_OF_PROCESSORS%

      - name: Package with CPack (7Z + ZIP)
        shell: cmd
        working-directory: build-${{ matrix.package_arch }}
        run: |
          cpack -G 7Z -C Release
          cpack -G ZIP -C Release

      - name: Rename Packages
        shell: cmd
        run: |
          set "VER=${{ steps.extract_version.outputs.project_version }}"
          set "ARCH=${{ matrix.package_arch }}"
          set "BUILD_DIR=build-%ARCH%"
          
          for %%f in ("%BUILD_DIR%\WinuxCmd-*.7z") do ren "%%f" "WinuxCmd-%VER%-win-%ARCH%.7z"
          for %%f in ("%BUILD_DIR%\WinuxCmd-*.zip") do ren "%%f" "WinuxCmd-%VER%-win-%ARCH%.zip"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WinuxCmd-${{ steps.extract_version.outputs.project_version }}-${{ matrix.package_arch }}
          path: |
            build-${{ matrix.package_arch }}/WinuxCmd-${{ steps.extract_version.outputs.project_version }}-win-${{ matrix.package_arch }}.7z
            build-${{ matrix.package_arch }}/WinuxCmd-${{ steps.extract_version.outputs.project_version }}-win-${{ matrix.package_arch }}.zip
          retention-days: 1
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build-windows
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    permissions:
      contents: write

    outputs:
      version: ${{ steps.final_version.outputs.version }}

    steps:
      - name: Extract Version from Tag
        id: final_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download x64 Packages
        uses: actions/download-artifact@v4
        with:
          name: WinuxCmd-${{ steps.final_version.outputs.version }}-x64
          path: artifacts/x64

      - name: Download ARM64 Packages
        uses: actions/download-artifact@v4
        with:
          name: WinuxCmd-${{ steps.final_version.outputs.version }}-arm64
          path: artifacts/arm64

      - name: Verify Packages
        run: |
          echo "=== Valid Packages ==="
          find artifacts -type f \( -name "*.7z" -o -name "*.zip" \) | sort || exit 1
          echo "======================"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/x64/*.7z
            artifacts/x64/*.zip
            artifacts/arm64/*.7z
            artifacts/arm64/*.zip
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Windows binaries for ${{ github.ref_name }}
            
            ### Architectures:
            - **x64**: Windows 64-bit
            - **ARM64**: Windows ARM64 (cross-compiled)
            
            ### Files included:
            - WinuxCmd-${{ steps.final_version.outputs.version }}-win-x64.7z
            - WinuxCmd-${{ steps.final_version.outputs.version }}-win-x64.zip
            - WinuxCmd-${{ steps.final_version.outputs.version }}-win-arm64.7z
            - WinuxCmd-${{ steps.final_version.outputs.version }}-win-arm64.zip
            
            ### Usage:
            1. Download the appropriate package for your architecture
            2. Extract to your desired directory
            3. Add the extracted `bin` directory to PATH
          draft: false
          prerelease: false
          generate_release_notes: true
          overwrite_files: 'true'
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cache-and-notify:
    runs-on: windows-latest
    needs: release  # Depends on release job
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')  # Only run on tag releases

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Refresh WinuxCmd Server Cache
        id: refresh-cache
        continue-on-error: true  # Cache refresh failure won't break the job
        env:
          CACHE_REFRESH_TOKEN: ${{ secrets.CACHE_REFRESH_TOKEN }}
        run: |
          .\.github\scripts\refresh-cache.ps1
        shell: pwsh

      - name: Send Notification
        id: notify
        continue-on-error: true  # Notification failure won't break the job
        env:
          CACHE_RESULT: ${{ steps.refresh-cache.outputs.cache-refresh-result || 'skipped' }}
          CACHE_MESSAGE: ${{ steps.refresh-cache.outputs.cache-message || '' }}
          CACHE_ERROR: ${{ steps.refresh-cache.outputs.cache-error || '' }}
          VERSION: ${{ needs.release.outputs.version || '' }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          .\.github\scripts\notify-cache-result.ps1 `
            -Result "$env:CACHE_RESULT" `
            -Message "$env:CACHE_MESSAGE" `
            -Error "$env:CACHE_ERROR" `
            -Version "$env:VERSION" `
            -TagName "$env:TAG_NAME"
        shell: pwsh