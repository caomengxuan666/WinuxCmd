# 脚手架和DSL设计文档

## 1. 脚手架工具

### 1.1 概述

脚手架工具（scaffold）是WinuxCmd项目提供的一个命令行工具，用于快速生成新命令的模板代码。它可以帮助开发者避免重复编写样板代码，提高开发效率，并确保所有命令都遵循项目的编码规范和架构设计。

### 1.2 功能特性

- **自动生成命令模板**：根据用户输入生成完整的命令实现模板
- **遵循项目规范**：确保生成的代码符合Google C++ Style Guide和项目的编码规范
- **包含必要的组件**：自动生成命令注册、参数解析、核心逻辑等必要组件
- **支持作者信息**：生成的代码包含作者信息字段，方便贡献者追踪

### 1.3 使用方法

1. **构建脚手架工具**：
   ```bash
   # 在项目根目录执行
   cmake --build . --target scaffold
   ```

2. **运行脚手架工具**：
   ```bash
   # 在build目录执行
   ./scaffold.exe <命令名称> <命令描述>
   ```

   例如，要创建一个名为`grep`的命令，描述为"搜索文本"，可以执行：
   ```bash
   ./scaffold.exe grep "搜索文本"
   ```

3. **查看生成的文件**：
   脚手架会在`src/commands/`目录下生成对应的命令文件，例如`grep.cppm`。

### 1.4 生成的文件结构

生成的命令文件包含以下主要部分：

- **模块声明**：使用C++23模块系统声明命令模块
- **必要的导入**：导入项目核心模块和标准库
- **命令选项定义**：使用DSL定义命令支持的选项
- **命令注册**：使用`REGISTER_COMMAND`宏注册命令
- **核心逻辑实现**：包含命令的主要功能实现
- **作者信息**：包含作者名称和邮箱字段

## 2. DSL设计

### 2.1 概述

DSL（Domain-Specific Language，领域特定语言）是WinuxCmd项目为了简化命令选项定义和处理而设计的一套声明式语法。它允许开发者以简洁、直观的方式定义命令的选项和参数，而无需编写繁琐的解析代码。

### 2.2 设计原理

DSL的设计基于以下原则：

- **简洁性**：使用简洁的语法定义命令选项，减少样板代码
- **类型安全**：利用C++的类型系统确保选项定义的正确性
- **可扩展性**：易于添加新的选项类型和处理逻辑
- **编译时验证**：在编译时验证选项定义的正确性，避免运行时错误

### 2.3 核心组件

#### 2.3.1 OPTION宏

`OPTION`宏是DSL的核心组件之一，用于定义命令的选项。它的语法如下：

```cpp
OPTION(短选项, 长选项, 描述)
```

例如：

```cpp
OPTION("-l", "--long", "使用长格式显示")
```

#### 2.3.2 REGISTER_COMMAND宏

`REGISTER_COMMAND`宏用于注册命令，将命令名称、描述、选项列表和实现函数关联起来。它的语法如下：

```cpp
REGISTER_COMMAND(命令名称, 命令描述, 选项列表, 命令函数, 帮助信息)
```

#### 2.3.3 选项处理系统

选项处理系统是DSL的运行时部分，负责：

- 解析命令行参数
- 验证选项的有效性
- 处理选项参数
- 生成帮助信息

### 2.4 使用示例

以下是一个使用DSL定义命令选项的示例：

```cpp
// 定义命令选项
constexpr auto LS_OPTIONS = std::array{
    OPTION("-l", "--long", "使用长格式显示"),
    OPTION("-a", "--all", "显示所有文件，包括隐藏文件"),
    OPTION("-h", "--human-readable", "以人类可读的格式显示文件大小"),
    OPTION("-r", "--reverse", "反向排序"),
};

// 注册命令
REGISTER_COMMAND("ls", "列出目录内容", LS_OPTIONS, ls_func, "列出目录内容")
{
    // 命令实现
    // ...
}
```

### 2.5 高级特性

#### 2.5.1 标志选项

标志选项是不需要参数的选项，用于启用或禁用某些功能。在DSL中，标志选项的定义与普通选项相同，只是在处理时不需要获取参数。

#### 2.5.2 参数选项

参数选项是需要参数的选项，例如`-f <文件>`。DSL会自动处理参数选项的参数获取和验证。

#### 2.5.3 帮助信息生成

DSL会根据选项定义自动生成帮助信息，包括选项的描述、用法示例等。

## 3. 开发流程

### 3.1 新命令开发步骤

1. **使用脚手架生成命令模板**
2. **修改命令选项定义**：根据命令的实际需求修改选项定义
3. **实现核心逻辑**：在生成的模板中实现命令的核心功能
4. **测试命令**：编译并测试命令的功能
5. **更新文档**：更新命令实现计划文档中的状态和说明

### 3.2 最佳实践

- **遵循编码规范**：确保代码符合Google C++ Style Guide
- **保持简洁**：实现命令的核心功能，避免过度复杂的实现
- **测试充分**：为命令编写单元测试，确保功能正确
- **文档完整**：更新命令的帮助信息和文档

## 4. 常见问题

### 4.1 脚手架生成的代码无法编译

**可能原因**：
- 命令名称不符合命名规范
- 命令描述包含特殊字符

**解决方案**：
- 使用合法的命令名称（仅包含字母、数字和下划线）
- 确保命令描述不包含特殊字符

### 4.2 选项解析失败

**可能原因**：
- 选项定义不正确
- 命令行参数格式错误

**解决方案**：
- 检查选项定义是否符合DSL语法
- 确保命令行参数格式正确

### 4.3 命令注册失败

**可能原因**：
- 命令名称已存在
- 选项列表格式错误

**解决方案**：
- 使用唯一的命令名称
- 检查选项列表是否正确定义

## 5. 总结

脚手架和DSL是WinuxCmd项目的重要工具，它们使得命令的开发变得更加简单、高效和规范。通过使用这些工具，开发者可以专注于命令的核心功能实现，而无需关心繁琐的样板代码和选项解析逻辑。

希望本文档能够帮助开发者理解和使用这些工具，为WinuxCmd项目贡献更多高质量的命令实现。